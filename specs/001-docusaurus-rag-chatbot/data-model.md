# Data Model: Docusaurus RAG Chatbot Integration

## Overview
This document defines the key entities and relationships for the Docusaurus RAG Chatbot Integration feature. The data model supports the core functionality of querying book content through a chat interface, retrieving relevant information from Qdrant embeddings and Neon Postgres metadata, and generating responses using OpenAI Agents.

## Entities

### 1. UserQuery

**Description**: Represents a user's question or text input in the chat interface.

**Fields**:
- `id` (string): Unique identifier for the query
- `text` (string): The actual text of the user's question or selected text
- `timestamp` (datetime): When the query was submitted
- `chatSessionId` (string): Reference to the associated chat session
- `context` (string): Optional context information (e.g., selected text from document)

**Relationships**:
- One-to-many with ChatSession (each session can have multiple queries)

**Validation Rules**:
- `text` must be non-empty (min length 1 character)
- `text` should not exceed 4000 characters (to prevent abuse)
- `chatSessionId` must reference an existing ChatSession

### 2. RetrievedContext

**Description**: Represents the relevant book content retrieved from Qdrant embeddings and Neon Postgres based on the user query.

**Fields**:
- `id` (string): Unique identifier for the retrieved context
- `queryId` (string): Reference to the associated UserQuery
- `content` (string): The actual text content retrieved from the book
- `sourceDocumentId` (string): Reference to the original document where this content was found
- `similarityScore` (float): Score indicating relevance to the original query (0.0 to 1.0)
- `metadata` (object): Additional metadata about the source document (title, chapter, section, etc.)

**Relationships**:
- Many-to-one with UserQuery (each query can retrieve multiple context items)
- Many-to-one with BookDocument (each context item comes from one document)

**Validation Rules**:
- `content` must be non-empty
- `similarityScore` must be between 0.0 and 1.0
- `sourceDocumentId` must reference an existing BookDocument

### 3. GeneratedResponse

**Description**: Represents the answer generated by the OpenAI Agents/ChatKit system based on the retrieved context.

**Fields**:
- `id` (string): Unique identifier for the response
- `queryId` (string): Reference to the associated UserQuery
- `responseText` (string): The actual text of the generated response
- `timestamp` (datetime): When the response was generated
- `confidenceScore` (float): Confidence score of the generated response (0.0 to 1.0)
- `sources` (array): List of source document references used to generate the response

**Relationships**:
- One-to-one with UserQuery (each query gets one response)
- Many-to-many with RetrievedContext (response can reference multiple context items)

**Validation Rules**:
- `responseText` must be non-empty
- `confidenceScore` must be between 0.0 and 1.0
- `queryId` must reference an existing UserQuery

### 4. ChatSession

**Description**: Represents the interaction state between the user and the chatbot.

**Fields**:
- `id` (string): Unique identifier for the session
- `userId` (string): Identifier for the user (can be anonymous)
- `startTime` (datetime): When the session started
- `endTime` (datetime): When the session ended (null if active)
- `isActive` (boolean): Whether the session is currently active
- `lastActivity` (datetime): When the last activity occurred in the session

**Relationships**:
- One-to-many with UserQuery (each session can have multiple queries)
- One-to-many with GeneratedResponse (each session can have multiple responses)

**Validation Rules**:
- `userId` must be non-empty
- `startTime` must be set when session is created
- `isActive` defaults to true when session is created

### 5. BookDocument

**Description**: Represents a document (chapter, section, etc.) from the book that has been indexed for retrieval.

**Fields**:
- `id` (string): Unique identifier for the document
- `title` (string): Title of the document
- `content` (string): Full text content of the document
- `metadata` (object): Additional metadata about the document (author, date, tags, etc.)
- `embeddingVector` (array): Vector representation of the document for similarity search
- `chunkSize` (integer): Size of text chunks used for embedding
- `chunkOverlap` (integer): Overlap between consecutive chunks

**Relationships**:
- One-to-many with RetrievedContext (each document can provide multiple context items)

**Validation Rules**:
- `id` must be unique across all documents
- `title` must be non-empty
- `content` must be non-empty
- `embeddingVector` must be a valid array of floats

## State Transitions

### ChatSession State Transitions

| Current State | Trigger | Next State | Description |
|---------------|---------|------------|-------------|
| Created | User clicks floating button | Active | Session becomes active when user opens chat interface |
| Active | User submits query | Active | Session remains active during interactions |
| Active | User closes chat or 15 minutes of inactivity | Ended | Session ends after inactivity or explicit closure |
| Ended | N/A | Ended | Final state - no further transitions |

### UserQuery State Transitions

| Current State | Trigger | Next State | Description |
|---------------|---------|------------|-------------|
| Created | System receives query | Processing | Query begins processing by backend |
| Processing | Context retrieved | Generating | System generates response using AI |
| Generating | Response generated | Completed | Query completes with generated response |
| Processing | Error occurs | Failed | Query fails due to backend issues |
| Completed | N/A | Completed | Final state |

## Relationships Diagram

```text
UserQuery ──(1..*)──> ChatSession
     │
     ├─(1..*)──> RetrievedContext
     │
     └─(1..1)──> GeneratedResponse
            │
            └─(1..*)──> RetrievedContext
            │
            └─(1..*)──> BookDocument
```

## Notes
- All entity IDs should follow UUID format for uniqueness
- Timestamp fields should use ISO 8601 format
- All text fields should support UTF-8 encoding
- Metadata fields should be flexible JSON objects to accommodate various document types